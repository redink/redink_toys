# xmpp base concepts
## 地址空间

> 和email一样, 为了通过网络路由和递送消息,XMPP使用全球唯一地址(基于DNS). 所有XMPP实体可以在网络上被寻址, 大部分客户端和服务器以及很多外部服务可以被客户端和服务器访问. 通常, 服务器地址的格式为 域部分 (例如, im.example.com), 属于某台服务器的帐号的格式为  "本地部分@域部分" (例如, <juliet@im.example.com>, 称为 "纯JID"), 而连接到一个特定的设备或资源并且已经被(服务器)授权可以和外部交互的客户端的格式为 <本地部分@域部分/资源部分> (例如, juliet@im.example.com/balcony, 称为 全JID ). 因为历史原因, XMPP地址常被称为Jabber IDs 或 JIDs.

以上为RFC 文档摘取。

XMPP 通讯是基于网络，所以每一个XMPP实体，都需要一个地址空间，被称为 `Jabber ID` 或 `JID`，一个合法的JID 地址包括：
- 1 本地部分（常指用户名）
- 2 域部分 （Jabber 服务器地址）
- 3 资源部分 （标示用户的设备或位置）

** 注 **

`本地部分`不一定是用户名，比如，在聊天室中，`room@localhost` 这里的`room`是指聊天室的名字，`localhost`是多用户聊天服务的Jabber 主机名。

** 附 **

在`ejabberd` 中，是由`stringprep` 和 `jid module` 来解析 JID 的。 [jid module take out from ejabberd](https://github.com/redink/jid)

## XMPP 基本语义
在XMPP 协议中，主要有三种语义：
- 1 message
- 2 presence
- 3 信息查询(Info/Query)或IQ

### 消息语义
> <message/>节是一个 推送 机制，这里一个实体推送信息到另一个实体, 类似发生在email系统里的通讯一样. 所有消息节将拥有 to 属性用来指定该消息期望的接收者 (见8.1.1和10.3), 除非消息是被一个已连接的客户端帐号的纯JID发送的. 接收到一个带有 to 地址的消息节之后, 服务器应该尝试路由或递送它到期望的接收者那里(见第十章里和XML节相关的通用路由和递送规则).

** 上述引用中提到的纯JID，即为resource 为空的JID **

##### 消息type
- 1 normal 单个的消息
- 2 chat 两个实体之间的实时对话
- 3 groupchat 多个实体在聊天室的实时对话
- 4 headline 发送警告和通知
- 5 error 若先前发送消息发生错误，实体检测这个问题将返回一个类型error的消息

##### 消息的TO
预期接受消息的实体的JID
##### 消息的FROM
发送者的JabberID，from地址不由发送客户端提供，而是由发送者的服务器添加邮戳，以避免地址欺骗。

### 联机状态语义
>  presence 节是一个特定的 广播 或 发布-订阅 机制, 这里多个实体接收关于他们订阅的一个实体的信息(在这个案例中, 是网络可用性信息). 通常, 发布客户端应该发送一个不带有 to 属性的联机状态节, 这种情况下该客户端连接的那个服务器将广播那个节给所有已订阅的实体. 然而, 发布客户端也可以发送一个带有 to 属性的联机状态节, 这种情况下该服务器将路由或递送那个节到期望的接收者. 尽管 presence 节大部分情况下是由XMPP客户端使用, 它也可能被服务器, 附加服务, 以及任何其他类型的XMPP实体使用. 

当某实体在线时，会向服务器宣告『出席』，然后服务器会将『这个实体在线』通告给这个实体的联系人。并且获取这些联系人的当前出席显示在这个实体的客户端界面上。

### IQ语义
> 信息查询(Info/Query),或IQ, 是一个"请求-应答"机制, 类似某些情况下的超文本传输协议HTTP. IQ的语义允许一个实体对另一个实体做出一个请求, 并接收一个应答. 这个请求和应答的数据内容由schema或其他限定IQ元素的直接子元素的XML命名空间相关的结构化定义来限定, 发出请求的实体使用'id'属性来跟踪交互过程. 所以, IQ交互沿用了结构化数据交换的常见模式，类似 get/result 或 set/result (尽管适当的时候对于某个请求会返回一个error):

```
  请求实体                     应答实体
----------                  ----------
    |                            |
    | <iq id='1' type='get'>     |
    |   [ ... payload ... ]      |
    | </iq>                      |
    | -------------------------> |
    |                            |
    | <iq id='1' type='result'>  |
    |   [ ... payload ... ]      |
    | </iq>                      |
    | <------------------------- |
    |                            |
    | <iq id='2' type='set'>     |
    |   [ ... payload ... ]      |
    | </iq>                      |
    | -------------------------> |
    |                            |
    | <iq id='2' type='error'>   |
    |   [ ... condition ... ]    |
    | </iq>                      |
    | <------------------------- |
    |                            |
```
#### IQ type
- 1 get 请求实体信息，例如请求注册一个账户 (类似于HTTP 的GET)
- 2 set 请求实体提供一些信息或作出一个请求（类似于HTTP POST或PUT）
- 3 result 应答实体返回get操作的结果（例如一个实体必须提供信息用来注册账户），或者确认一个set请求（类似于一个HTTP200状态码）
- 4 error 应答实体或一个中间实体，例如XMPP服务器，通知请求实体它不能处理get或set请求
